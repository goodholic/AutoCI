@page "/codegen"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>AI ì½”ë“œ ìƒì„± - AutoCI</PageTitle>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-lg-12">
            <div class="d-flex align-items-center mb-4">
                <h1 class="h2 me-3">ğŸ¤– AI ì½”ë“œ ìƒì„±ê¸°</h1>
                <span class="badge bg-primary">Code Llama 7B-Instruct</span>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- ì™¼ìª½: ì…ë ¥ ì˜ì—­ -->
        <div class="col-lg-5">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-pencil-square me-2"></i>ì½”ë“œ ìš”ì²­ì‚¬í•­</h5>
                </div>
                <div class="card-body">
                    <!-- ë¹ ë¥¸ í…œí”Œë¦¿ ì„ íƒ -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸš€ ë¹ ë¥¸ í…œí”Œë¦¿</label>
                        <div class="d-grid gap-2">
                            <button @onclick="@(() => SetTemplate("unity_player"))" class="btn btn-outline-primary btn-sm text-start">
                                <i class="bi bi-controller me-2"></i>Unity í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ëŸ¬
                            </button>
                            <button @onclick="@(() => SetTemplate("unity_enemy"))" class="btn btn-outline-primary btn-sm text-start">
                                <i class="bi bi-bug me-2"></i>Unity ì  AI ìŠ¤í¬ë¦½íŠ¸
                            </button>
                            <button @onclick="@(() => SetTemplate("aspnet_controller"))" class="btn btn-outline-primary btn-sm text-start">
                                <i class="bi bi-server me-2"></i>ASP.NET API ì»¨íŠ¸ë¡¤ëŸ¬
                            </button>
                            <button @onclick="@(() => SetTemplate("singleton"))" class="btn btn-outline-primary btn-sm text-start">
                                <i class="bi bi-box me-2"></i>ì‹±ê¸€í†¤ íŒ¨í„´ í´ë˜ìŠ¤
                            </button>
                        </div>
                    </div>

                    <!-- í”„ë¡¬í”„íŠ¸ ì…ë ¥ -->
                    <div class="mb-3">
                        <label for="prompt" class="form-label fw-bold">ğŸ“ ì–´ë–¤ ì½”ë“œë¥¼ ë§Œë“¤ì–´ë“œë¦´ê¹Œìš”?</label>
                        <textarea @bind="prompt" 
                                  class="form-control" 
                                  id="prompt" 
                                  rows="8" 
                                  placeholder="ì˜ˆì‹œ: Unityì—ì„œ 3ì¸ì¹­ ì¹´ë©”ë¼ë¥¼ ë”°ë¼ë‹¤ë‹ˆëŠ” í”Œë ˆì´ì–´ ì´ë™ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤˜. WASDë¡œ ì´ë™í•˜ê³  Spaceë¡œ ì í”„í•  ìˆ˜ ìˆê²Œ í•´ì¤˜.">
                        </textarea>
                        <small class="text-muted">ìì„¸íˆ ì„¤ëª…í• ìˆ˜ë¡ ë” ì •í™•í•œ ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</small>
                    </div>

                    <!-- ì˜µì…˜ ì„¤ì • -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">âš™ï¸ ìƒì„± ì˜µì…˜</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="addComments" id="addComments">
                            <label class="form-check-label" for="addComments">
                                ì£¼ì„ í¬í•¨
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="addExamples" id="addExamples">
                            <label class="form-check-label" for="addExamples">
                                ì‚¬ìš© ì˜ˆì‹œ í¬í•¨
                            </label>
                        </div>
                    </div>

                    <!-- ìƒì„± ë²„íŠ¼ -->
                    <div class="d-grid">
                        <button @onclick="GenerateCode" 
                                class="btn btn-primary btn-lg" 
                                disabled="@isGenerating">
                            @if (isGenerating)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>ì½”ë“œ ìƒì„± ì¤‘...</span>
                            }
                            else
                            {
                                <i class="bi bi-magic me-2"></i>
                                <span>ì½”ë“œ ìƒì„±í•˜ê¸°</span>
                            }
                        </button>
                    </div>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger mt-3 mb-0" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            @errorMessage
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ê²°ê³¼ ì˜ì—­ -->
        <div class="col-lg-7">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-code-slash me-2"></i>ìƒì„±ëœ ì½”ë“œ</h5>
                    @if (!string.IsNullOrEmpty(generatedCode))
                    {
                        <button @onclick="CopyToClipboard" class="btn btn-sm btn-light">
                            <i class="bi bi-clipboard"></i> ë³µì‚¬
                        </button>
                    }
                </div>
                <div class="card-body">
                    @if (string.IsNullOrEmpty(generatedCode))
                    {
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-code-square" style="font-size: 4rem;"></i>
                            <p class="mt-3">ì™¼ìª½ì—ì„œ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„¤ëª…í•˜ê³  'ì½”ë“œ ìƒì„±í•˜ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                            <small>ìƒì„±ëœ ì½”ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</small>
                        </div>
                    }
                    else
                    {
                        <pre class="language-csharp"><code>@generatedCode</code></pre>
                        
                        <!-- ì¶”ê°€ ì‘ì—… ë²„íŠ¼ë“¤ -->
                        <div class="mt-3 d-flex gap-2 flex-wrap">
                            <button @onclick="ImproveCode" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-arrow-clockwise me-1"></i>ì½”ë“œ ê°œì„ í•˜ê¸°
                            </button>
                            <button @onclick="AddTests" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-check2-square me-1"></i>í…ŒìŠ¤íŠ¸ ì½”ë“œ ì¶”ê°€
                            </button>
                            <button @onclick="ExplainCode" class="btn btn-outline-info btn-sm">
                                <i class="bi bi-question-circle me-1"></i>ì½”ë“œ ì„¤ëª…
                            </button>
                            <button @onclick="SaveFeedback" class="btn btn-outline-success btn-sm">
                                <i class="bi bi-hand-thumbs-up me-1"></i>í•™ìŠµ ë°ì´í„°ë¡œ ì €ì¥
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš© íŒ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>ì‚¬ìš© íŒ</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="fw-bold">âœ… ì¢‹ì€ í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ</h6>
                            <ul class="small">
                                <li>êµ¬ì²´ì ì¸ ê¸°ëŠ¥ ì„¤ëª…</li>
                                <li>ì‚¬ìš©í•  Unity ì»´í¬ë„ŒíŠ¸ ëª…ì‹œ</li>
                                <li>ì›í•˜ëŠ” ë””ìì¸ íŒ¨í„´ ì–¸ê¸‰</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6 class="fw-bold">ğŸ¯ ì§€ì›í•˜ëŠ” ì½”ë“œ ìœ í˜•</h6>
                            <ul class="small">
                                <li>Unity MonoBehaviour ìŠ¤í¬ë¦½íŠ¸</li>
                                <li>ASP.NET Core ì»¨íŠ¸ë¡¤ëŸ¬/ì„œë¹„ìŠ¤</li>
                                <li>ì¼ë°˜ C# í´ë˜ìŠ¤ ë° ì¸í„°í˜ì´ìŠ¤</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6 class="fw-bold">ğŸ’¡ ì¶”ê°€ ê¸°ëŠ¥</h6>
                            <ul class="small">
                                <li>ìƒì„±ëœ ì½”ë“œ ì¦‰ì‹œ ê°œì„  ê°€ëŠ¥</li>
                                <li>ìë™ìœ¼ë¡œ í•™ìŠµ ë°ì´í„° ìˆ˜ì§‘</li>
                                <li>í”¼ë“œë°±ìœ¼ë¡œ ëª¨ë¸ ì„±ëŠ¥ í–¥ìƒ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string prompt = "";
    private string generatedCode = "";
    private bool isGenerating = false;
    private string errorMessage = "";
    private bool addComments = true;
    private bool addExamples = false;

    private Dictionary<string, string> templates = new Dictionary<string, string>
    {
        ["unity_player"] = "Unityì—ì„œ 3ì¸ì¹­ í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ëŸ¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤˜. WASDë¡œ ì´ë™, ë§ˆìš°ìŠ¤ë¡œ íšŒì „, Spaceë¡œ ì í”„, Shiftë¡œ ë‹¬ë¦¬ê¸° ê¸°ëŠ¥ì„ í¬í•¨í•´ì¤˜.",
        ["unity_enemy"] = "Unityì—ì„œ í”Œë ˆì´ì–´ë¥¼ ì¶”ì í•˜ëŠ” ì  AI ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤˜. ì¼ì • ê±°ë¦¬ ë‚´ì—ì„œ í”Œë ˆì´ì–´ë¥¼ ê°ì§€í•˜ê³ , NavMeshAgentë¥¼ ì‚¬ìš©í•´ì„œ ì¶”ì í•˜ë„ë¡ í•´ì¤˜.",
        ["aspnet_controller"] = "ASP.NET Coreì—ì„œ RESTful API ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“¤ì–´ì¤˜. CRUD ì‘ì—…ì„ ìœ„í•œ GET, POST, PUT, DELETE ì—”ë“œí¬ì¸íŠ¸ë¥¼ í¬í•¨í•˜ê³ , ë¹„ë™ê¸° ì²˜ë¦¬ì™€ ì—ëŸ¬ í•¸ë“¤ë§ì„ ì¶”ê°€í•´ì¤˜.",
        ["singleton"] = "C#ìœ¼ë¡œ ìŠ¤ë ˆë“œ ì•ˆì „í•œ ì‹±ê¸€í†¤ íŒ¨í„´ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì¤˜. Lazy<T>ë¥¼ ì‚¬ìš©í•œ ì§€ì—° ì´ˆê¸°í™”ì™€ í•¨ê»˜ êµ¬í˜„í•´ì¤˜."
    };

    private void SetTemplate(string templateKey)
    {
        if (templates.TryGetValue(templateKey, out var template))
        {
            prompt = template;
        }
    }

    private async Task GenerateCode()
    {
        if (string.IsNullOrWhiteSpace(prompt))
        {
            errorMessage = "ì½”ë“œ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            return;
        }

        isGenerating = true;
        errorMessage = "";
        generatedCode = "";

        try
        {
            var enhancedPrompt = prompt;
            if (addComments)
            {
                enhancedPrompt += "\n\nì£¼ì„ì„ í¬í•¨í•´ì„œ ì½”ë“œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.";
            }
            if (addExamples)
            {
                enhancedPrompt += "\n\nì‚¬ìš© ì˜ˆì‹œë„ í•¨ê»˜ í¬í•¨í•´ì£¼ì„¸ìš”.";
            }

            var response = await Http.PostAsJsonAsync("api/ai/generate", 
                new { prompt = enhancedPrompt });
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GenerateResponse>();
                generatedCode = result?.Code ?? "// ì½”ë“œ ìƒì„± ì‹¤íŒ¨";
            }
            else
            {
                errorMessage = "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"ì˜¤ë¥˜ ë°œìƒ: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task ImproveCode()
    {
        if (string.IsNullOrEmpty(generatedCode)) return;

        var improvePrompt = $"ë‹¤ìŒ ì½”ë“œë¥¼ ê°œì„ í•´ì¤˜. ì„±ëŠ¥ ìµœì í™”, ì—ëŸ¬ ì²˜ë¦¬, ì½”ë“œ ê°€ë…ì„±ì„ í–¥ìƒì‹œì¼œì¤˜:\n\n{generatedCode}";
        prompt = improvePrompt;
        await GenerateCode();
    }

    private async Task AddTests()
    {
        if (string.IsNullOrEmpty(generatedCode)) return;

        var testPrompt = $"ë‹¤ìŒ ì½”ë“œì— ëŒ€í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•´ì¤˜:\n\n{generatedCode}";
        prompt = testPrompt;
        await GenerateCode();
    }

    private async Task ExplainCode()
    {
        if (string.IsNullOrEmpty(generatedCode)) return;

        var explainPrompt = $"ë‹¤ìŒ ì½”ë“œë¥¼ í•œê¸€ë¡œ ìì„¸íˆ ì„¤ëª…í•´ì¤˜:\n\n{generatedCode}";
        prompt = explainPrompt;
        await GenerateCode();
    }

    private async Task SaveFeedback()
    {
        if (string.IsNullOrEmpty(generatedCode)) return;

        try
        {
            var feedback = new
            {
                prompt = prompt,
                code = generatedCode,
                rating = "positive"
            };

            await Http.PostAsJsonAsync("api/ai/feedback", feedback);
            await JSRuntime.InvokeVoidAsync("alert", "í•™ìŠµ ë°ì´í„°ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ëª¨ë¸ ì„±ëŠ¥ í–¥ìƒì— ë„ì›€ì´ ë©ë‹ˆë‹¤.");
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("alert", "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    private async Task CopyToClipboard()
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", generatedCode);
        await JSRuntime.InvokeVoidAsync("alert", "ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }

    public class GenerateResponse
    {
        public string Code { get; set; } = "";
        public string Explanation { get; set; } = "";
    }
}