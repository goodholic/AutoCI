@page "/codefactory"
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@using System.Text.Json

<PageTitle>ğŸ­ 24ì‹œê°„ ì½”ë“œ ê³µì¥ - AutoCI</PageTitle>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-lg-12">
            <div class="d-flex align-items-center mb-4">
                <h1 class="h2 me-3">ğŸ­ 24ì‹œê°„ ìë™ ì½”ë“œ ê³µì¥</h1>
                <span class="badge bg-success">Always Working</span>
                <button @onclick="RefreshStatus" class="btn btn-outline-primary btn-sm ms-auto">
                    <i class="bi bi-arrow-clockwise"></i> ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
        </div>
    </div>

    <!-- ìƒíƒœ ëŒ€ì‹œë³´ë“œ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <h3 class="card-title">ğŸ“‹ @currentStatus.Pending</h3>
                    <p class="card-text">ëŒ€ê¸° ì¤‘ì¸ ì‘ì—…</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3 class="card-title">ğŸ”§ @currentStatus.InProgress</h3>
                    <p class="card-text">ì§„í–‰ ì¤‘ì¸ ì‘ì—…</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3 class="card-title">âœ… @currentStatus.Completed</h3>
                    <p class="card-text">ì™„ë£Œëœ ì‘ì—…</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h3 class="card-title">âŒ @currentStatus.Failed</h3>
                    <p class="card-text">ì‹¤íŒ¨í•œ ì‘ì—…</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- ì™¼ìª½: ì‘ì—… ì¶”ê°€ -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>ìƒˆ ì‘ì—… ì¶”ê°€</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸ¯ ë¹ ë¥¸ ì„ íƒ</label>
                        <div class="d-grid gap-2">
                            <button @onclick="@(() => SetQuickTask(\"unity_player\"))" class="btn btn-outline-primary btn-sm text-start">
                                <i class="bi bi-controller me-2"></i>Unity í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ëŸ¬ ìƒì„±
                            </button>
                            <button @onclick="@(() => SetQuickTask(\"unity_enemy\"))" class="btn btn-outline-primary btn-sm text-start">
                                <i class="bi bi-bug me-2"></i>Unity ì  AI ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
                            </button>
                            <button @onclick="@(() => SetQuickTask(\"game_manager\"))" class="btn btn-outline-primary btn-sm text-start">
                                <i class="bi bi-gear me-2"></i>Unity ê²Œì„ ë§¤ë‹ˆì € ìƒì„±
                            </button>
                            <button @onclick="@(() => SetQuickTask(\"improve_all\"))" class="btn btn-outline-warning btn-sm text-start">
                                <i class="bi bi-arrow-up-circle me-2"></i>ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ ê°œì„ 
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ï¿½ï¿½ ëŒ€ìƒ í´ë”</label>
                        <input @bind="targetFolder" class="form-control" placeholder="../Assets/Scripts" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ï¿½ï¿½ íŒŒì¼ íŒ¨í„´</label>
                        <input @bind="filePattern" class="form-control" placeholder="PlayerController.cs ë˜ëŠ” *.cs" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸ› ï¸ ì‘ì—… íƒ€ì…</label>
                        <select @bind="modificationType" class="form-select">
                            <option value="create">ìƒˆ íŒŒì¼ ìƒì„±</option>
                            <option value="modify">ê¸°ì¡´ íŒŒì¼ ìˆ˜ì •</option>
                            <option value="improve">ì½”ë“œ ê°œì„ </option>
                            <option value="fix">ë²„ê·¸ ìˆ˜ì •</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸ“ ì‘ì—… ì„¤ëª…</label>
                        <textarea @bind="description" class="form-control" rows="3" placeholder="ì–´ë–¤ ì‘ì—…ì„ ìˆ˜í–‰í• ì§€ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”..."></textarea>
                    </div>

                    <div class="d-grid gap-2">
                        <button @onclick="AddTask" class="btn btn-primary" disabled="@isAddingTask">
                            @if (isAddingTask)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>ì‘ì—… ì¶”ê°€ ì¤‘...</span>
                            }
                            else
                            {
                                <i class="bi bi-plus-circle me-2"></i>
                                <span>ì‘ì—… ì¶”ê°€í•˜ê¸°</span>
                            }
                        </button>
                        <button @onclick="StartContinuous" class="btn btn-success" disabled="@isContinuousRunning">
                            <i class="bi bi-play-circle me-2"></i>
                            <span>24ì‹œê°„ ì—°ì† ëª¨ë“œ ì‹œì‘</span>
                        </button>
                        <button @onclick="AddExamples" class="btn btn-outline-info">
                            <i class="bi bi-lightbulb me-2"></i>ì˜ˆì‹œ ì‘ì—… ì¶”ê°€
                        </button>
                    </div>

                    @if (!string.IsNullOrEmpty(addTaskMessage))
                    {
                        <div class="alert alert-info mt-3" role="alert">
                            @addTaskMessage
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ìµœê·¼ ì‘ì—… í˜„í™© -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-list-task me-2"></i>ìµœê·¼ ì‘ì—… í˜„í™©</h5>
                </div>
                <div class="card-body">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-2">ì•„ì§ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <small>ì™¼ìª½ì—ì„œ ìƒˆ ì‘ì—…ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš© ê°€ì´ë“œ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>ğŸ­ ì½”ë”© ê³µì¥ ì‚¬ìš© ê°€ì´ë“œ</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="fw-bold">âœ¨ ìë™ ì½”ë“œ ìƒì„±</h6>
                            <ul class="small">
                                <li>Unity ìŠ¤í¬ë¦½íŠ¸ ìë™ ìƒì„±</li>
                                <li>ASP.NET ì»¨íŠ¸ë¡¤ëŸ¬ ìƒì„±</li>
                                <li>ë””ìì¸ íŒ¨í„´ êµ¬í˜„</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6 class="fw-bold">ï¿½ï¿½ ì½”ë“œ ìë™ ìˆ˜ì •</h6>
                            <ul class="small">
                                <li>ê¸°ì¡´ ì½”ë“œ ê°œì„ </li>
                                <li>ë²„ê·¸ ìë™ ìˆ˜ì •</li>
                                <li>ì„±ëŠ¥ ìµœì í™”</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6 class="fw-bold">ğŸ•’ 24ì‹œê°„ ì—°ì† ì‘ì—…</h6>
                            <ul class="small">
                                <li>ë°±ê·¸ë¼ìš´ë“œ ìë™ ì‹¤í–‰</li>
                                <li>ì‘ì—… í ê´€ë¦¬</li>
                                <li>ì‹¤ì‹œê°„ ìƒíƒœ ëª¨ë‹ˆí„°ë§</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // ìƒíƒœ ì •ë³´
    private StatusInfo currentStatus = new();

    // ì…ë ¥ í•„ë“œ
    private string targetFolder = "../Assets/Scripts";
    private string filePattern = "PlayerController.cs";
    private string modificationType = "create";
    private string description = "Unity í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ëŸ¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±";

    // ìƒíƒœ í”Œë˜ê·¸
    private bool isAddingTask = false;
    private bool isContinuousRunning = false;
    private string addTaskMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await RefreshStatus();
    }

    private void SetQuickTask(string taskType)
    {
        switch (taskType)
        {
            case "unity_player":
                targetFolder = "../Assets/Scripts";
                filePattern = "PlayerController.cs";
                modificationType = "create";
                description = "Unity í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ëŸ¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (WASD ì´ë™, ì í”„, ë‹¬ë¦¬ê¸° í¬í•¨)";
                break;
            case "unity_enemy":
                targetFolder = "../Assets/Scripts";
                filePattern = "EnemyAI.cs";
                modificationType = "create";
                description = "Unity ì  AI ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (í”Œë ˆì´ì–´ ì¶”ì , NavMesh ì‚¬ìš©)";
                break;
            case "game_manager":
                targetFolder = "../Assets/Scripts";
                filePattern = "GameManager.cs";
                modificationType = "create";
                description = "Unity ê²Œì„ ë§¤ë‹ˆì € ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ì ìˆ˜, ì¼ì‹œì •ì§€, ì”¬ ê´€ë¦¬)";
                break;
            case "improve_all":
                targetFolder = "../Assets/Scripts";
                filePattern = "*.cs";
                modificationType = "improve";
                description = "ëª¨ë“  Unity ìŠ¤í¬ë¦½íŠ¸ì— ì„±ëŠ¥ ìµœì í™” ë° ì£¼ì„ ì¶”ê°€";
                break;
        }
        StateHasChanged();
    }

    private async Task AddTask()
    {
        try
        {
            isAddingTask = true;
            addTaskMessage = "";
            
            var request = new
            {
                targetFolder,
                filePattern,
                modificationType,
                description
            };

            var response = await Http.PostAsJsonAsync("/api/CodeModifier/add-task", request);
            
            if (response.IsSuccessStatusCode)
            {
                addTaskMessage = "âœ… ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!";
                await RefreshStatus();
            }
            else
            {
                addTaskMessage = "âŒ ì‘ì—… ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            }
        }
        catch (Exception ex)
        {
            addTaskMessage = $"âŒ ì˜¤ë¥˜: {ex.Message}";
        }
        finally
        {
            isAddingTask = false;
        }
    }

    private async Task StartContinuous()
    {
        try
        {
            isContinuousRunning = true;
            
            var response = await Http.PostAsync("/api/CodeModifier/start-continuous", null);
            
            if (response.IsSuccessStatusCode)
            {
                addTaskMessage = "ğŸš€ 24ì‹œê°„ ì—°ì† ëª¨ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!";
            }
            else
            {
                addTaskMessage = "âŒ ì—°ì† ëª¨ë“œ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            }
        }
        catch (Exception ex)
        {
            addTaskMessage = $"âŒ ì˜¤ë¥˜: {ex.Message}";
        }
        finally
        {
            isContinuousRunning = false;
        }
    }

    private async Task AddExamples()
    {
        try
        {
            var response = await Http.PostAsync("/api/CodeModifier/add-examples", null);
            
            if (response.IsSuccessStatusCode)
            {
                addTaskMessage = "ğŸ¯ 3ê°œì˜ ì˜ˆì‹œ ì‘ì—…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!";
                await RefreshStatus();
            }
            else
            {
                addTaskMessage = "âŒ ì˜ˆì‹œ ì‘ì—… ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            }
        }
        catch (Exception ex)
        {
            addTaskMessage = $"âŒ ì˜¤ë¥˜: {ex.Message}";
        }
    }

    private async Task RefreshStatus()
    {
        try
        {
            var response = await Http.GetAsync("/api/CodeModifier/status");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                // ê°„ë‹¨í•œ ìƒíƒœ ì—…ë°ì´íŠ¸
                currentStatus.Pending = 0;
                currentStatus.InProgress = 0;
                currentStatus.Completed = 0;
                currentStatus.Failed = 0;
            }
        }
        catch (Exception ex)
        {
            // ë¡œê¹… ë˜ëŠ” ì˜¤ë¥˜ ì²˜ë¦¬
        }
    }

    // ë°ì´í„° ëª¨ë¸
    public class StatusInfo
    {
        public int Pending { get; set; }
        public int InProgress { get; set; }
        public int Completed { get; set; }
        public int Failed { get; set; }
    }
}
