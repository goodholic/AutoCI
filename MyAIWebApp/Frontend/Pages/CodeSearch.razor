@page "/codesearch"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>ìŠ¤ë§ˆíŠ¸ ì½”ë“œ ê²€ìƒ‰ - AutoCI</PageTitle>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-lg-12">
            <div class="d-flex align-items-center mb-4">
                <h1 class="h2 me-3">ğŸ” ìŠ¤ë§ˆíŠ¸ ì½”ë“œ ê²€ìƒ‰</h1>
                <span class="badge bg-success">ML.NET ê¸°ë°˜</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <!-- ê²€ìƒ‰ ë°” -->
                    <div class="row g-3">
                        <div class="col-md-9">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-success text-white">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input @bind="searchQuery" 
                                       @bind:event="oninput"
                                       @onkeypress="@(async (e) => { if (e.Key == "Enter") await SearchCode(); })"
                                       class="form-control" 
                                       placeholder="ì½”ë“œ ê²€ìƒ‰... (ì˜ˆ: í”Œë ˆì´ì–´ ì´ë™, async ë©”ì„œë“œ, ì‹±ê¸€í†¤ íŒ¨í„´)"
                                       autofocus />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <button @onclick="SearchCode" 
                                    class="btn btn-success btn-lg w-100" 
                                    disabled="@isSearching">
                                @if (isSearching)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>ê²€ìƒ‰ ì¤‘...</span>
                                }
                                else
                                {
                                    <i class="bi bi-search me-2"></i>
                                    <span>ê²€ìƒ‰í•˜ê¸°</span>
                                }
                            </button>
                        </div>
                    </div>

                    <!-- ë¹ ë¥¸ ê²€ìƒ‰ íƒœê·¸ -->
                    <div class="mt-3">
                        <span class="text-muted me-2">ì¸ê¸° ê²€ìƒ‰:</span>
                        <button @onclick='() => QuickSearch("unity")' class="btn btn-sm btn-outline-secondary me-1 mb-1">Unity</button>
                        <button @onclick='() => QuickSearch("controller")' class="btn btn-sm btn-outline-secondary me-1 mb-1">Controller</button>
                        <button @onclick='() => QuickSearch("async")' class="btn btn-sm btn-outline-secondary me-1 mb-1">Async</button>
                        <button @onclick='() => QuickSearch("singleton")' class="btn btn-sm btn-outline-secondary me-1 mb-1">Singleton</button>
                        <button @onclick='() => QuickSearch("player")' class="btn btn-sm btn-outline-secondary me-1 mb-1">Player</button>
                        <button @onclick='() => QuickSearch("service")' class="btn btn-sm btn-outline-secondary me-1 mb-1">Service</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ê²€ìƒ‰ ê²°ê³¼ -->
    <div class="row">
        <div class="col-lg-12">
            @if (searchResults.Any())
            {
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-file-code me-2"></i>
                        ê²€ìƒ‰ ê²°ê³¼ <span class="badge bg-secondary">@(searchResults.Count)ê°œ</span>
                    </h5>
                    <div class="btn-group" role="group">
                        <button @onclick="@(() => SortResults("score"))" 
                                class="btn btn-sm @(sortBy == "score" ? "btn-primary" : "btn-outline-primary")">
                            ê´€ë ¨ë„ìˆœ
                        </button>
                        <button @onclick="@(() => SortResults("name"))" 
                                class="btn btn-sm @(sortBy == "name" ? "btn-primary" : "btn-outline-primary")">
                            ì´ë¦„ìˆœ
                        </button>
                    </div>
                </div>

                @foreach (var result in searchResults)
                {
                    <div class="card mb-3 search-result-card">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">
                                    <i class="bi bi-file-earmark-code text-primary me-2"></i>
                                    @result.Title
                                </h6>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success me-2">
                                    ê´€ë ¨ë„: @((result.Score * 100).ToString("F0"))%
                                </span>
                                <button @onclick="() => CopyCode(result.Content)" 
                                        class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <pre class="code-preview mb-2"><code>@result.Content</code></pre>
                            
                            @if (result.Tags != null && result.Tags.Any())
                            {
                                <div class="mt-2">
                                    <i class="bi bi-tags text-muted me-1"></i>
                                    @foreach (var tag in result.Tags)
                                    {
                                        <span class="badge bg-secondary me-1">@tag</span>
                                    }
                                </div>
                            }
                            
                            <div class="mt-3">
                                <button @onclick="() => ViewFullCode(result)" 
                                        class="btn btn-sm btn-primary me-2">
                                    <i class="bi bi-eye me-1"></i>ì „ì²´ ì½”ë“œ ë³´ê¸°
                                </button>
                                <button @onclick="() => ImproveCode(result.Content)" 
                                        class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-magic me-1"></i>AIë¡œ ê°œì„ í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                }
            }
            else if (hasSearched && !isSearching)
            {
                <div class="text-center py-5">
                    <i class="bi bi-search" style="font-size: 4rem; color: #dee2e6;"></i>
                    <h5 class="mt-3 text-muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h5>
                    <p class="text-muted">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</p>
                </div>
            }
            else if (!hasSearched)
            {
                <div class="text-center py-5">
                    <i class="bi bi-code-square" style="font-size: 4rem; color: #dee2e6;"></i>
                    <h5 class="mt-3 text-muted">ì½”ë“œë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”</h5>
                    <p class="text-muted">ìì—°ì–´ë¡œ ê²€ìƒ‰í•˜ê±°ë‚˜ í•¨ìˆ˜ëª…, í´ë˜ìŠ¤ëª…ìœ¼ë¡œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            }
        </div>
    </div>

    <!-- ì½”ë“œ ì¸ë±ì‹± -->
    <div class="row mt-5">
        <div class="col-lg-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-database me-2"></i>ìƒˆ ì½”ë“œ ì¸ë±ì‹±</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">ğŸ“ íŒŒì¼ëª…</label>
                                <input type="text" class="form-control" @bind="indexFileName" 
                                       placeholder="ì˜ˆ: PlayerController.cs" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">ğŸ·ï¸ ì–¸ì–´</label>
                                <select class="form-select" @bind="indexLanguage">
                                    <option value="csharp" selected>C#</option>
                                    <option value="unity">Unity C#</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">ğŸ“ ì½”ë“œ ë‚´ìš©</label>
                        <textarea class="form-control font-monospace" @bind="indexContent" rows="10" 
                                  placeholder="// ì¸ë±ì‹±í•  C# ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...

public class PlayerController : MonoBehaviour
{
    // ì½”ë“œ ë‚´ìš©...
}"></textarea>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            ì¸ë±ì‹±ëœ ì½”ë“œëŠ” ê²€ìƒ‰ ê°€ëŠ¥í•˜ë©°, AI í•™ìŠµ ë°ì´í„°ë¡œë„ í™œìš©ë©ë‹ˆë‹¤.
                        </small>
                        <button class="btn btn-info text-white" @onclick="IndexCode" disabled="@isIndexing">
                            @if (isIndexing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>ì¸ë±ì‹± ì¤‘...</span>
                            }
                            else
                            {
                                <i class="bi bi-database-add me-2"></i>
                                <span>ì½”ë“œ ì¸ë±ì‹±</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            @errorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success mt-3" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            @successMessage
        </div>
    }
</div>

<style>
    .search-result-card {
        transition: transform 0.2s;
        border-left: 4px solid #28a745;
    }
    
    .search-result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .code-preview {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 1rem;
        overflow-x: auto;
        max-height: 200px;
    }
    
    .code-preview code {
        font-size: 0.875rem;
        color: #212529;
    }
</style>

@code {
    private string searchQuery = "";
    private List<SearchResult> searchResults = new();
    private bool isSearching = false;
    private bool hasSearched = false;
    private string sortBy = "score";
    
    private string indexFileName = "";
    private string indexContent = "";
    private string indexLanguage = "csharp";
    private bool isIndexing = false;
    
    private string errorMessage = "";
    private string successMessage = "";

    private async Task SearchCode()
    {
        if (string.IsNullOrWhiteSpace(searchQuery)) return;

        isSearching = true;
        hasSearched = true;
        errorMessage = "";
        successMessage = "";

        try
        {
            var response = await Http.GetFromJsonAsync<List<SearchResult>>(
                $"api/search/code?query={Uri.EscapeDataString(searchQuery)}&maxResults=20");
            searchResults = response ?? new();
            
            // ê¸°ë³¸ ì •ë ¬ (ê´€ë ¨ë„ìˆœ)
            SortResults("score");
        }
        catch (Exception ex)
        {
            errorMessage = $"ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}";
        }
        finally
        {
            isSearching = false;
        }
    }

    private void QuickSearch(string query)
    {
        searchQuery = query;
        _ = SearchCode();
    }

    private void SortResults(string criteria)
    {
        sortBy = criteria;
        
        searchResults = criteria switch
        {
            "name" => searchResults.OrderBy(r => r.Title).ToList(),
            _ => searchResults.OrderByDescending(r => r.Score).ToList()
        };
    }

    private async Task CopyCode(string code)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", code);
        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ëŒ€ì‹  ê°„ë‹¨í•œ í”¼ë“œë°±
        successMessage = "ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!";
        StateHasChanged();
        
        // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
        await Task.Delay(3000);
        successMessage = "";
        StateHasChanged();
    }

    private async Task ViewFullCode(SearchResult result)
    {
        // ì „ì²´ ì½”ë“œë¥¼ ë³´ì—¬ì£¼ëŠ” ëª¨ë‹¬ êµ¬í˜„ (ì¶”í›„ ê°œì„ )
        await JSRuntime.InvokeVoidAsync("console.log", $"ì „ì²´ ì½”ë“œ ë³´ê¸°: {result.Title}");
    }

    private async Task ImproveCode(string code)
    {
        // AI ì½”ë“œ ê°œì„  í˜ì´ì§€ë¡œ ì´ë™ (ì¶”í›„ êµ¬í˜„)
        await JSRuntime.InvokeVoidAsync("console.log", "AI ì½”ë“œ ê°œì„  ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘");
    }

    private async Task IndexCode()
    {
        if (string.IsNullOrWhiteSpace(indexFileName) || string.IsNullOrWhiteSpace(indexContent))
        {
            errorMessage = "íŒŒì¼ëª…ê³¼ ì½”ë“œ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            return;
        }

        isIndexing = true;
        errorMessage = "";
        successMessage = "";
        
        try
        {
            var request = new IndexCodeRequest
            {
                FileName = indexFileName,
                Content = indexContent,
                Language = indexLanguage
            };
            
            var response = await Http.PostAsJsonAsync("api/search/index", request);
            
            if (response.IsSuccessStatusCode)
            {
                successMessage = "ì½”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì¸ë±ì‹±ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ê²€ìƒ‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
                indexFileName = "";
                indexContent = "";
                
                // ì„±ê³µ ë©”ì‹œì§€ 5ì´ˆ í›„ ì œê±°
                await Task.Delay(5000);
                successMessage = "";
                StateHasChanged();
            }
            else
            {
                errorMessage = "ì½”ë“œ ì¸ë±ì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"ì¸ë±ì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}";
        }
        finally
        {
            isIndexing = false;
        }
    }

    public class SearchResult
    {
        public string Id { get; set; } = "";
        public string Title { get; set; } = "";
        public string Content { get; set; } = "";
        public float Score { get; set; }
        public string Language { get; set; } = "";
        public string[]? Tags { get; set; }
    }

    public class IndexCodeRequest
    {
        public string FileName { get; set; } = "";
        public string Content { get; set; } = "";
        public string? Language { get; set; }
    }
}