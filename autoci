#!/usr/bin/env python3
"""
AutoCI - AI ê²Œì„ ê°œë°œ ì‹œìŠ¤í…œ
24ì‹œê°„ ìë™ ê²Œì„ ê°œë°œ AI
"""

import sys
import os
import asyncio
from pathlib import Path

# í”„ë¡œì íŠ¸ ê²½ë¡œ ì¶”ê°€
PROJECT_ROOT = Path("/mnt/d/AutoCI/AutoCI")
sys.path.insert(0, str(PROJECT_ROOT))
sys.path.insert(0, str(PROJECT_ROOT / 'core_system'))
sys.path.insert(0, str(PROJECT_ROOT / 'modules'))
sys.path.insert(0, str(PROJECT_ROOT / 'modules_active'))

# Xlib ê²½ê³  ì–µì œ
from core.xlib_suppressor import suppress_all_xlib_warnings
suppress_all_xlib_warnings()

# ê°€ìƒí™˜ê²½ í™œì„±í™” ì²´í¬
def check_virtualenv():
    """ê°€ìƒí™˜ê²½ ì²´í¬ ë° í™œì„±í™” ì•ˆë‚´"""
    if not hasattr(sys, 'real_prefix') and not (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix):
        print("âš ï¸  ê°€ìƒí™˜ê²½ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        print("ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ê°€ìƒí™˜ê²½ì„ í™œì„±í™”í•˜ì„¸ìš”:")
        print("  source autoci_env/bin/activate  # Linux/WSL")
        print("  autoci_env\\Scripts\\activate.bat  # Windows")
        return False
    return True


def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    # ê°€ìƒí™˜ê²½ ì²´í¬
    if not check_virtualenv():
        print("\nê°€ìƒí™˜ê²½ ì—†ì´ ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): ", end='')
        if input().lower() != 'y':
            sys.exit(1)
    
    # ëª…ë ¹ì¤„ ì¸ì ì²˜ë¦¬
    if len(sys.argv) > 1:
        command = sys.argv[1].lower()
        
        if command == 'learn':
            # AI í•™ìŠµ ëª¨ë“œ
            if len(sys.argv) > 2 and sys.argv[2] == 'low':
                print("ğŸ§  ë©”ëª¨ë¦¬ ìµœì í™” í•™ìŠµ ëª¨ë“œ ì‹œì‘...")
                os.system(f"python {PROJECT_ROOT}/core_system/continuous_learning_system.py --low-memory")
            else:
                print("ğŸ§  í†µí•© í•™ìŠµ ëª¨ë“œ ì‹œì‘...")
                os.system(f"python {PROJECT_ROOT}/core_system/continuous_learning_system.py")
        
        elif command == 'monitor':
            # ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ
            print("ğŸ“Š ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ì‹œì‘...")
            os.system(f"python {PROJECT_ROOT}/modules/realtime_monitoring_system.py")
        
        elif command == 'fix':
            # í•™ìŠµ ê¸°ë°˜ ì—”ì§„ ê°œì„ 
            print("ğŸ”§ í•™ìŠµ ê¸°ë°˜ ì—”ì§„ ê°œì„  ì‹œì‘...")
            os.system(f"python {PROJECT_ROOT}/core_system/ai_engine_updater.py")
        
        elif command == 'chat':
            # í•œê¸€ ëŒ€í™” ëª¨ë“œ
            print("ğŸ’¬ í•œê¸€ ëŒ€í™” ëª¨ë“œ ì‹œì‘...")
            asyncio.run(chat_mode())
        
        elif command == '--help' or command == '-h':
            show_help()
        
        else:
            print(f"âŒ ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: {command}")
            show_help()
    
    else:
        # ê¸°ë³¸ ì‹¤í–‰ (ëŒ€í™”í˜• ëª¨ë“œ)
        try:
            from core_system.autoci_panda3d_main import AutoCIPanda3DMain
            asyncio.run(interactive_mode())
        except ImportError as e:
            print(f"âŒ ëª¨ë“ˆ ì„í¬íŠ¸ ì˜¤ë¥˜: {e}")
            print("\ní•„ìš”í•œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ì„¸ìš”:")
            print("  pip install -r requirements.txt")
            sys.exit(1)


async def interactive_mode():
    """ëŒ€í™”í˜• ëª¨ë“œ"""
    from core_system.autoci_panda3d_main import AutoCIPanda3DMain
    autoci = AutoCIPanda3DMain()
    await autoci.start()


async def chat_mode():
    """í•œê¸€ ëŒ€í™” ì „ìš© ëª¨ë“œ"""
    try:
        from modules.korean_conversation_interface import KoreanConversationInterface
        from modules.ai_model_integration import AIModelIntegration
    except ImportError as e:
        print(f"âŒ ëª¨ë“ˆ ì„í¬íŠ¸ ì˜¤ë¥˜: {e}")
        return
    
    ai_model = AIModelIntegration()
    chat_interface = KoreanConversationInterface(ai_model)
    
    print("\nğŸ’¬ AutoCI í•œê¸€ ëŒ€í™” ëª¨ë“œ")
    print("=" * 50)
    print("ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ëŒ€í™”í•˜ì„¸ìš”. 'ì¢…ë£Œ'ë¥¼ ì…ë ¥í•˜ë©´ ëë‚©ë‹ˆë‹¤.")
    print("=" * 50)
    
    while True:
        user_input = input("\nì‚¬ìš©ì: ")
        if user_input.lower() in ['ì¢…ë£Œ', 'exit', 'quit']:
            print("ëŒ€í™”ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            break
        
        response = await chat_interface.process_input(user_input)
        print(f"\nAutoCI: {response}")


def show_help():
    """ë„ì›€ë§ í‘œì‹œ"""
    print("""
AutoCI - AI ê²Œì„ ê°œë°œ ì‹œìŠ¤í…œ v5.0

ì‚¬ìš©ë²•:
  autoci                    ëŒ€í™”í˜• ëª¨ë“œ ì‹œì‘
  autoci learn              AI í†µí•© í•™ìŠµ ì‹œì‘
  autoci learn low          ë©”ëª¨ë¦¬ ìµœì í™” í•™ìŠµ (8GB VRAM)
  autoci monitor            ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ
  autoci fix                í•™ìŠµ ê¸°ë°˜ ì—”ì§„ ê°œì„ 
  autoci chat               í•œê¸€ ëŒ€í™” ì „ìš© ëª¨ë“œ
  autoci --help             ë„ì›€ë§ í‘œì‹œ

ëŒ€í™”í˜• ëª¨ë“œ ëª…ë ¹ì–´:
  create [type] game        ê²Œì„ ìƒì„± (platformer, racing, rpg, puzzle)
  add feature [name]        ê¸°ëŠ¥ ì¶”ê°€
  modify [aspect]           ê²Œì„ ìˆ˜ì •
  open_panda3d             Panda3D ì—ë””í„° ì—´ê¸°
  status                    ì‹œìŠ¤í…œ ìƒíƒœ
  help                      ë„ì›€ë§
  exit/quit/ì¢…ë£Œ           ì¢…ë£Œ

ì˜ˆì œ:
  autoci
  > create platformer game  # í”Œë«í¼ ê²Œì„ ìƒì„±
  > add feature double_jump # ë”ë¸” ì í”„ ê¸°ëŠ¥ ì¶”ê°€
  > status                  # ê°œë°œ ìƒíƒœ í™•ì¸
""")


if __name__ == "__main__":
    main()