#!/bin/bash
# AutoCI - WSL í„°ë¯¸ë„ ëª…ë ¹ì–´ ìŠ¤í¬ë¦½íŠ¸

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# AutoCI ë””ë ‰í† ë¦¬ ì„¤ì •
AUTOCI_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$AUTOCI_DIR"

# ê°€ìƒí™˜ê²½ ê²½ë¡œ ì„¤ì •
VENV_PATH=""
if [ -d "llm_venv_wsl" ]; then
    VENV_PATH="llm_venv_wsl"
elif [ -d "llm_venv" ]; then
    VENV_PATH="llm_venv"
elif [ -d "venv" ]; then
    VENV_PATH="venv"
fi

# ê°€ìƒí™˜ê²½ í™œì„±í™”
if [ -n "$VENV_PATH" ] && [ -f "$VENV_PATH/bin/activate" ]; then
    echo -e "${GREEN}âœ“ ê°€ìƒí™˜ê²½ í™œì„±í™”: $VENV_PATH${NC}"
    source "$VENV_PATH/bin/activate"
else
    echo -e "${YELLOW}âš ï¸  ê°€ìƒí™˜ê²½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹œìŠ¤í…œ Pythonì„ ì‚¬ìš©í•©ë‹ˆë‹¤.${NC}"
fi

# íŒŒì´ì¬ í™˜ê²½ í™•ì¸
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}âŒ Python3ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.${NC}"
    exit 1
fi

# ëª…ë ¹ì–´ ì²˜ë¦¬
case "$1" in
    # ì‹œìŠ¤í…œ ì‹œì‘
    start)
        echo -e "${GREEN}ğŸš€ AutoCI ì‹œìŠ¤í…œì„ ì‹œì‘í•©ë‹ˆë‹¤...${NC}"
        python3 autoci_terminal.py --start
        ;;
    
    # ëŒ€í™”í˜• ëª¨ë“œ
    terminal|t)
        echo -e "${BLUE}ğŸ¤– AutoCI í„°ë¯¸ë„ ëª¨ë“œ${NC}"
        python3 autoci_terminal.py --interactive
        ;;
    
    # í•œêµ­ì–´ AI ëŒ€í™” ëª¨ë“œ
    korean|k|í•œêµ­ì–´)
        echo -e "${CYAN}ğŸ‡°ğŸ‡· AutoCI ChatGPT ìˆ˜ì¤€ í•œêµ­ì–´ AI ëŒ€í™” ëª¨ë“œ${NC}"
        echo -e "${GREEN}ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ëŒ€í™”í•˜ì„¸ìš”!${NC}"
        echo -e "${BLUE}âœ¨ ê²©ì‹ì²´/ë°˜ë§ ìë™ ê°ì§€, ê°ì • ì¸ì‹, Unity ì „ë¬¸ ì§€ì‹ í†µí•©${NC}"
        
        # ì˜ì¡´ì„± í™•ì¸ í›„ ì ì ˆí•œ ë²„ì „ ì‹¤í–‰
        if python3 -c "import rich, colorama, psutil" 2>/dev/null; then
            echo -e "${GREEN}âœ… ê³ ê¸‰ í•œêµ­ì–´ AI ì‹¤í–‰${NC}"
            python3 "$AUTOCI_DIR/autoci_interactive.py"
        else
            echo -e "${YELLOW}âš ï¸  ê°„ë‹¨í•œ í•œêµ­ì–´ AI ì‹¤í–‰${NC}"
            python3 "$AUTOCI_DIR/autoci_simple_interactive.py"
        fi
        ;;
    
    # ë¹ ë¥¸ ëª…ë ¹ ì‹¤í–‰
    create|c)
        shift
        python3 autoci_terminal.py "ë§Œë“¤ì–´ì¤˜ $*"
        ;;
    
    modify|m)
        shift
        python3 autoci_terminal.py "ìˆ˜ì •í•´ì¤˜ $*"
        ;;
    
    improve|i)
        shift
        python3 autoci_terminal.py "ê°œì„ í•´ì¤˜ $*"
        ;;
    
    fix|f)
        shift
        python3 autoci_terminal.py "ê³ ì³ì¤˜ $*"
        ;;
    
    # ë°ì´í„° ê´€ë¦¬
    data)
        case "$2" in
            add)
                echo -e "${YELLOW}ğŸ“¥ ì „ë¬¸ê°€ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...${NC}"
                python3 autoci_terminal.py "ë°ì´í„° ì¶”ê°€"
                ;;
            index)
                echo -e "${YELLOW}ğŸ” ë²¡í„° ê¸°ë°˜ ê³ ê¸‰ ì¸ë±ì‹± ì¤‘...${NC}"
                python3 vector_indexer.py
                ;;
            *)
                echo "ì‚¬ìš©ë²•: autoci data [add|index]"
                ;;
        esac
        ;;
    
    # ì‹œìŠ¤í…œ ìƒíƒœ
    status|s)
        python3 autoci_terminal.py "ìƒíƒœ"
        ;;
    
    # Dual Phase ì‹œìŠ¤í…œ
    dual)
        case "$2" in
            start)
                echo -e "${GREEN}ğŸš€ Robust Dual Phase System ì‹œì‘ (RAG + Fine-tuning)${NC}"
                echo -e "${YELLOW}ì›¹ UI: http://localhost:8080${NC}"
                python3 robust_dual_phase.py start
                ;;
            stop)
                echo -e "${RED}ğŸ›‘ Dual Phase System ì¢…ë£Œ${NC}"
                python3 robust_dual_phase.py stop
                ;;
            status)
                echo -e "${YELLOW}ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ${NC}"
                python3 robust_dual_phase.py status
                ;;
            report)
                echo -e "${CYAN}ğŸ“ ìƒíƒœ ë¦¬í¬íŠ¸${NC}"
                # ìµœì‹  dual phase ë¦¬í¬íŠ¸ ì°¾ê¸°
                REPORT_DIR="$AUTOCI_DIR/autoci_reports"
                if [ -d "$REPORT_DIR" ]; then
                    LATEST_REPORT=$(ls -t "$REPORT_DIR"/final_report_*.md 2>/dev/null | head -n1)
                    if [ -f "$LATEST_REPORT" ]; then
                        cat "$LATEST_REPORT"
                    else
                        echo "ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹œìŠ¤í…œì„ ì‹¤í–‰í•˜ì„¸ìš”."
                    fi
                else
                    echo "ë¦¬í¬íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
                fi
                ;;
            *)
                echo "ì‚¬ìš©ë²•: autoci dual [start|stop|status|report]"
                ;;
        esac
        ;;
    
    # RAG ì‹œìŠ¤í…œ
    rag)
        case "$2" in
            start)
                echo -e "${GREEN}ğŸ” Enhanced RAG v2.0 ì„œë²„ ì‹œì‘${NC}"
                python3 enhanced_rag_system_v2.py --server
                ;;
            test)
                python3 enhanced_rag_system_v2.py --test
                ;;
            query)
                shift 2
                python3 enhanced_rag_system_v2.py --query "$*"
                ;;
            *)
                echo "ì‚¬ìš©ë²•: autoci rag [start|test|query <ì§ˆë¬¸>]"
                ;;
        esac
        ;;
    
    # í–¥ìƒëœ ì‹œìŠ¤í…œ (24ì‹œê°„ ìë™ ì½”ë“œ ìˆ˜ì •)
    enhance)
        shift
        case "$1" in
            start)
                echo -e "${GREEN}ğŸš€ 24ì‹œê°„ ìë™ ì½”ë“œ ìˆ˜ì • ì‹œìŠ¤í…œ ì‹œì‘${NC}"
                shift
                if [ -n "$1" ]; then
                    echo -e "${BLUE}ğŸ“ ëŒ€ìƒ ê²½ë¡œ: $1${NC}"
                    python3 "$AUTOCI_DIR/advanced_autoci_system.py" start --path "$1"
                else
                    echo -e "${BLUE}ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬ì—ì„œ ì‹œì‘${NC}"
                    python3 "$AUTOCI_DIR/advanced_autoci_system.py" start
                fi
                ;;
            stop)
                echo -e "${RED}ğŸ›‘ ì‹œìŠ¤í…œ ì¢…ë£Œ${NC}"
                python3 "$AUTOCI_DIR/advanced_autoci_system.py" stop
                ;;
            status)
                echo -e "${YELLOW}ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸${NC}"
                python3 "$AUTOCI_DIR/advanced_autoci_system.py" status
                ;;
            collect)
                echo -e "${BLUE}ğŸ“š ì‹¬ì¸µ C# ì „ë¬¸ ë°ì´í„° ìˆ˜ì§‘${NC}"
                python3 "$AUTOCI_DIR/deep_csharp_collector.py"
                ;;
            report)
                echo -e "${CYAN}ğŸ“ ìµœì‹  ë¦¬í¬íŠ¸ ë³´ê¸°${NC}"
                # ìµœì‹  ë¦¬í¬íŠ¸ íŒŒì¼ ì°¾ê¸°
                REPORT_DIR="$AUTOCI_DIR/autoci_reports"
                if [ -d "$REPORT_DIR" ]; then
                    LATEST_REPORT=$(ls -t "$REPORT_DIR"/*.md 2>/dev/null | head -n1)
                    if [ -f "$LATEST_REPORT" ]; then
                        cat "$LATEST_REPORT"
                    else
                        echo "ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì‹œìŠ¤í…œì„ ì‹¤í–‰í•˜ì„¸ìš”."
                    fi
                else
                    echo "ë¦¬í¬íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
                fi
                ;;
            *)
                echo -e "${YELLOW}ì‚¬ìš©ë²•: autoci enhance [start|stop|status|collect|report] [ì˜µì…˜]${NC}"
                echo "  start [ê²½ë¡œ]      # 24ì‹œê°„ ìë™ ì‹œìŠ¤í…œ ì‹œì‘"
                echo "  stop              # ì‹œìŠ¤í…œ ì¢…ë£Œ"
                echo "  status            # í˜„ì¬ ìƒíƒœ í™•ì¸"
                echo "  collect           # C# ì „ë¬¸ ë°ì´í„° ìˆ˜ì§‘"
                echo "  report            # ìµœì‹  ë¦¬í¬íŠ¸ ë³´ê¸°"
                echo ""
                echo "ì˜ˆì‹œ:"
                echo "  autoci enhance start /home/user/my-project"
                echo "  autoci enhance start  # í˜„ì¬ ë””ë ‰í† ë¦¬"
                ;;
        esac
        ;;
    
    # 24ì‹œê°„ ì—°ì† í•™ìŠµ ì‹œìŠ¤í…œ
    learn)
        shift
        case "$1" in
            start)
                echo -e "${GREEN}ğŸ§  AutoCI 24ì‹œê°„ ì—°ì† í•™ìŠµ ì‹œìŠ¤í…œ ì‹œì‘${NC}"
                echo -e "${BLUE}ğŸ“š C# ì „ë¬¸ ì§€ì‹ ì§€ì†ì  í¬ë¡¤ë§ ë° í•™ìŠµ${NC}"
                python3 "$AUTOCI_DIR/start_continuous_learning.py" start
                ;;
            stop)
                echo -e "${RED}ğŸ›‘ ì—°ì† í•™ìŠµ ì‹œìŠ¤í…œ ì¢…ë£Œ${NC}"
                python3 "$AUTOCI_DIR/start_continuous_learning.py" stop
                ;;
            restart)
                echo -e "${YELLOW}ğŸ”„ ì—°ì† í•™ìŠµ ì‹œìŠ¤í…œ ì¬ì‹œì‘${NC}"
                python3 "$AUTOCI_DIR/start_continuous_learning.py" restart
                ;;
            status)
                echo -e "${CYAN}ğŸ“Š ì—°ì† í•™ìŠµ ìƒíƒœ í™•ì¸${NC}"
                python3 "$AUTOCI_DIR/start_continuous_learning.py" status
                ;;
            logs)
                shift
                if [ -n "$1" ]; then
                    echo -e "${YELLOW}ğŸ“„ ì—°ì† í•™ìŠµ ë¡œê·¸ (ìµœê·¼ $1ì¤„)${NC}"
                    python3 "$AUTOCI_DIR/start_continuous_learning.py" logs "$1"
                else
                    echo -e "${YELLOW}ğŸ“„ ì—°ì† í•™ìŠµ ë¡œê·¸ (ìµœê·¼ 50ì¤„)${NC}"
                    python3 "$AUTOCI_DIR/start_continuous_learning.py" logs
                fi
                ;;
            simple)
                echo -e "${GREEN}ğŸ§  ê°„ë‹¨í•œ ì—°ì† í•™ìŠµ ì‹œìŠ¤í…œ (ëŒ€í™”í˜•)${NC}"
                echo -e "${BLUE}âœ¨ ì˜ì¡´ì„± ì—†ì´ ì‹¤í–‰ ê°€ëŠ¥í•œ ë²„ì „${NC}"
                python3 "$AUTOCI_DIR/autoci_simple_continuous_learning.py"
                ;;
            demo)
                echo -e "${CYAN}ğŸš€ ì—°ì† í•™ìŠµ ë°ëª¨ ì‹¤í–‰${NC}"
                echo -e "${YELLOW}âœ¨ ì‹¤ì œ í•™ìŠµ AI ê°œë… ì‹œì—°${NC}"
                python3 "$AUTOCI_DIR/autoci_learning_ai_concept.py"
                ;;
            *)
                echo -e "${YELLOW}ì‚¬ìš©ë²•: autoci learn [start|stop|restart|status|logs|simple|demo] [ì˜µì…˜]${NC}"
                echo ""
                echo "  start             # 24ì‹œê°„ ì—°ì† í•™ìŠµ ì‹œì‘"
                echo "  stop              # ì—°ì† í•™ìŠµ ì¤‘ì§€"
                echo "  restart           # ì—°ì† í•™ìŠµ ì¬ì‹œì‘"
                echo "  status            # í•™ìŠµ ìƒíƒœ ë° í†µê³„ í™•ì¸"
                echo "  logs [ì¤„ìˆ˜]       # í•™ìŠµ ë¡œê·¸ ë³´ê¸° (ê¸°ë³¸: 50ì¤„)"
                echo "  simple            # ê°„ë‹¨í•œ ë²„ì „ (ì˜ì¡´ì„± ì—†ìŒ)"
                echo "  demo              # ì‹¤ì œ í•™ìŠµ AI ê°œë… ë°ëª¨"
                echo ""
                echo "íŠ¹ì§•:"
                echo "  ğŸ§  ChatGPT ìˆ˜ì¤€ í•™ìŠµ: Microsoft Docs, Unity, GitHub, StackOverflow í¬ë¡¤ë§"
                echo "  ğŸ“Š ì‹¤ì‹œê°„ í†µê³„: í•™ìŠµ ì„¸ì…˜, ì§€ì‹ ì¦ê°€ëŸ‰, ì •í™•ë„ í–¥ìƒ ì¶”ì "
                echo "  ğŸ”„ ìë™ ë³µêµ¬: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ìë™ ì¬ì‹œë„"
                echo "  ğŸ—„ï¸ ì§€ì‹ë² ì´ìŠ¤: SQLite ê¸°ë°˜ ì˜êµ¬ ì €ì¥"
                echo ""
                echo "ì˜ˆì‹œ:"
                echo "  autoci learn start     # ë°±ê·¸ë¼ìš´ë“œ í•™ìŠµ ì‹œì‘"
                echo "  autoci learn status    # ì‹¤ì‹œê°„ ìƒíƒœ í™•ì¸"
                echo "  autoci learn logs 100  # ìµœê·¼ 100ì¤„ ë¡œê·¸"
                echo "  autoci learn simple    # ëŒ€í™”í˜• ê°„ë‹¨ ë²„ì „"
                ;;
        esac
        ;;
    
    # ì¸í„°ë™í‹°ë¸Œ ëª¨ë“œ (ì¸ì ì—†ì´ ì‹¤í–‰)
    "")
        echo -e "${CYAN}ğŸ¤– AutoCI ChatGPT ìˆ˜ì¤€ í•œêµ­ì–´ AI í†µí•© ì‹œìŠ¤í…œ${NC}"
        echo -e "${GREEN}ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...${NC}"
        echo -e "${BLUE}âœ¨ ChatGPT ìˆ˜ì¤€ì˜ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ ëŒ€í™” ì§€ì›${NC}"
        
        # ì—…ê·¸ë ˆì´ë“œëœ í•œêµ­ì–´ AI ë²„ì „ ì‹œë„
        echo -e "${YELLOW}ğŸ”„ ì˜ì¡´ì„± í™•ì¸ ì¤‘...${NC}"
        if python3 -c "import rich, colorama, psutil" 2>/dev/null; then
            echo -e "${GREEN}âœ… ëª¨ë“  ì˜ì¡´ì„± ì„¤ì¹˜ë¨ - ê³ ê¸‰ ë²„ì „ ì‹¤í–‰${NC}"
            python3 "$AUTOCI_DIR/autoci_interactive.py"
        else
            echo -e "${YELLOW}âš ï¸  ì¼ë¶€ ì˜ì¡´ì„± ëˆ„ë½ - ê°„ë‹¨í•œ ë²„ì „ ì‹¤í–‰${NC}"
            echo -e "${CYAN}ğŸ’¡ ì™„ì „í•œ ê¸°ëŠ¥ì„ ìœ„í•´ ë‹¤ìŒ ëª…ë ¹ì–´ ì‹¤í–‰: bash install_dependencies_wsl.sh${NC}"
            python3 "$AUTOCI_DIR/autoci_simple_interactive.py"
        fi
        ;;
    
    # ë„ì›€ë§
    help|h)
        echo -e "${BLUE}ğŸ¤– AutoCI - 24ì‹œê°„ ìë™ ì½”ë“œ ìˆ˜ì • ì‹œìŠ¤í…œ${NC}"
        echo ""
        echo "ì‚¬ìš©ë²•: autoci [ëª…ë ¹] [ì˜µì…˜]"
        echo ""
        echo "ê¸°ë³¸ ëª…ë ¹ì–´:"
        echo "  start              - ëª¨ë“  ì‹œìŠ¤í…œ ì‹œì‘"
        echo "  terminal, t        - ëŒ€í™”í˜• í„°ë¯¸ë„ ëª¨ë“œ"
        echo "  korean, k, í•œêµ­ì–´   - ChatGPT ìˆ˜ì¤€ í•œêµ­ì–´ AI ëŒ€í™” ëª¨ë“œ ğŸ‡°ğŸ‡·"
        echo "  status, s          - ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸"
        echo ""
        echo "ë¹ ë¥¸ ì½”ë“œ ìˆ˜ì •:"
        echo "  create, c <ì„¤ëª…>   - ì½”ë“œ ìƒì„± (ì˜ˆ: autoci c PlayerController í´ë˜ìŠ¤)"
        echo "  modify, m <íŒŒì¼>   - ì½”ë“œ ìˆ˜ì • (ì˜ˆ: autoci m GameManager.cs)"
        echo "  improve, i <íŒŒì¼>  - ì½”ë“œ ê°œì„  (ì˜ˆ: autoci i /path/to/file.cs)"
        echo "  fix, f <ì„¤ëª…>      - ë²„ê·¸ ìˆ˜ì • (ì˜ˆ: autoci f NetworkManager ì˜¤ë¥˜)"
        echo ""
        echo "ë°ì´í„° ê´€ë¦¬:"
        echo "  data add           - ì „ë¬¸ê°€ ë°ì´í„° ìˆ˜ì§‘"
        echo "  data index         - ë°ì´í„° ì¸ë±ì‹±"
        echo ""
        echo "ê³ ê¸‰ ê¸°ëŠ¥:"
        echo "  dual start         - Enhanced Dual Phase System ì‹œì‘"
        echo "  dual stop          - Dual Phase System ì¢…ë£Œ"
        echo "  dual status        - Dual Phase ìƒíƒœ í™•ì¸"
        echo "  dual report        - Dual Phase ìƒíƒœ ë¦¬í¬íŠ¸"
        echo "  rag start          - RAG ì„œë²„ë§Œ ì‹œì‘"
        echo "  rag test           - RAG ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸"
        echo "  rag query <ì§ˆë¬¸>   - RAG ì¿¼ë¦¬ ì‹¤í–‰"
        echo ""
        echo "24ì‹œê°„ ìë™ ì‹œìŠ¤í…œ:"
        echo "  enhance start [ê²½ë¡œ] - 24ì‹œê°„ ìë™ ì½”ë“œ ìˆ˜ì • ì‹œì‘"
        echo "  enhance stop         - ì‹œìŠ¤í…œ ì¢…ë£Œ"
        echo "  enhance status       - í˜„ì¬ ìƒíƒœ í™•ì¸"
        echo "  enhance collect      - C# ì „ë¬¸ ë°ì´í„° ìˆ˜ì§‘"
        echo "  enhance report       - ìµœì‹  ë¦¬í¬íŠ¸ ë³´ê¸°"
        echo ""
        echo "24ì‹œê°„ ì—°ì† í•™ìŠµ ì‹œìŠ¤í…œ:"
        echo "  learn start          - ë°±ê·¸ë¼ìš´ë“œ ì—°ì† í•™ìŠµ ì‹œì‘ ğŸ§ "
        echo "  learn stop           - ì—°ì† í•™ìŠµ ì¤‘ì§€"
        echo "  learn restart        - ì—°ì† í•™ìŠµ ì¬ì‹œì‘"
        echo "  learn status         - í•™ìŠµ ìƒíƒœ ë° í†µê³„ í™•ì¸"
        echo "  learn logs [ì¤„ìˆ˜]    - í•™ìŠµ ë¡œê·¸ ë³´ê¸°"
        echo "  learn simple         - ê°„ë‹¨ ë²„ì „ (ì˜ì¡´ì„± ì—†ìŒ)"
        echo "  learn demo           - ì‹¤ì œ í•™ìŠµ AI ê°œë… ë°ëª¨"
        echo ""
        echo "ì˜ˆì‹œ:"
        echo "  autoci c Unityì—ì„œ Object Pool íŒ¨í„´ êµ¬í˜„"
        echo "  autoci m Assets/Scripts/Player.cs ìœ„ì¹˜: /home/user/project"
        echo "  autoci terminal    # ëŒ€í™”í˜• ëª¨ë“œë¡œ ì§„ì…"
        echo "  autoci learn start # ChatGPT ìˆ˜ì¤€ 24ì‹œê°„ í•™ìŠµ ì‹œì‘"
        ;;
    
    # ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹
    *)
        # í•œê¸€ ëª…ë ¹ì–´ë„ Python ìŠ¤í¬ë¦½íŠ¸ë¡œ ì „ë‹¬
        python3 autoci_terminal.py "$@"
        ;;
esac