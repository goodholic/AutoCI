#!/usr/bin/env python3
"""
WSLì—ì„œ AI Godot Windows ë¹Œë“œ ì‹¤í–‰
MinGWë¥¼ ì‚¬ìš©í•˜ì—¬ Windows exe íŒŒì¼ì„ í¬ë¡œìŠ¤ ì»´íŒŒì¼
"""
import os
import subprocess
import sys
from pathlib import Path
import time
import shutil
import urllib.request
import zipfile

# ìƒ‰ìƒ ì½”ë“œ
GREEN = '\033[92m'
YELLOW = '\033[93m'
RED = '\033[91m'
BLUE = '\033[94m'
CYAN = '\033[96m'
RESET = '\033[0m'

def check_dependencies():
    """í•„ìˆ˜ ì˜ì¡´ì„± í™•ì¸ ë° ì„¤ì¹˜"""
    print(f"{YELLOW}ğŸ” ë¹Œë“œ ì˜ì¡´ì„± í™•ì¸ ì¤‘...{RESET}")
    
    missing_deps = []
    has_mingw = False
    
    # MinGW í™•ì¸
    try:
        subprocess.run(["x86_64-w64-mingw32-g++", "--version"], capture_output=True, check=True)
        print(f"  âœ… MinGW-w64 ì„¤ì¹˜ë¨")
        has_mingw = True
    except:
        print(f"  âš ï¸  MinGW-w64 ì—†ìŒ (ë¯¸ë¦¬ ë¹Œë“œëœ ë²„ì „ ì‚¬ìš©)")
    
    # SCons í™•ì¸ (MinGWê°€ ìˆì„ ë•Œë§Œ í•„ìš”)
    if has_mingw:
        try:
            subprocess.run(["scons", "--version"], capture_output=True, check=True)
            print(f"  âœ… SCons ì„¤ì¹˜ë¨")
        except:
            missing_deps.append("scons")
    
    # í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ (MinGWê°€ ìˆì„ ë•Œë§Œ í•„ìš”)
    if has_mingw:
        required_packages = ["pkg-config", "libx11-dev", "libgl1-mesa-dev"]
        for pkg in required_packages:
            result = subprocess.run(["dpkg", "-l", pkg], capture_output=True)
            if result.returncode != 0:
                missing_deps.append(pkg)
            else:
                print(f"  âœ… {pkg} ì„¤ì¹˜ë¨")
    
    if missing_deps:
        print(f"\n{YELLOW}ğŸ“¦ ëˆ„ë½ëœ íŒ¨í‚¤ì§€ê°€ ìˆìŠµë‹ˆë‹¤:{RESET}")
        print(f"   sudo apt install {' '.join(missing_deps)}")
        print(f"\n{YELLOW}ì†ŒìŠ¤ ë¹Œë“œë¥¼ ê±´ë„ˆë›°ê³  ë¯¸ë¦¬ ë¹Œë“œëœ ë²„ì „ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.{RESET}")
        return has_mingw
    
    return has_mingw

def download_godot_source(project_dir):
    """Godot ì†ŒìŠ¤ì½”ë“œ ë‹¤ìš´ë¡œë“œ"""
    source_dir = project_dir / "godot_modified" / "godot-source"
    
    if source_dir.exists() and (source_dir / "SConstruct").exists():
        print(f"{GREEN}âœ… Godot ì†ŒìŠ¤ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.{RESET}")
        return source_dir
    
    print(f"{BLUE}ğŸ“¥ Godot 4.3 ì†ŒìŠ¤ì½”ë“œ ë‹¤ìš´ë¡œë“œ ì¤‘...{RESET}")
    
    # ë””ë ‰í† ë¦¬ ìƒì„±
    source_dir.parent.mkdir(parents=True, exist_ok=True)
    
    # ë‹¤ìš´ë¡œë“œ
    url = "https://github.com/godotengine/godot/archive/4.3-stable.zip"
    zip_path = source_dir.parent / "godot-source.zip"
    
    try:
        def download_progress(block_num, block_size, total_size):
            downloaded = block_num * block_size
            percent = min(downloaded * 100 / total_size, 100)
            print(f"\r  ì§„í–‰ë¥ : {percent:.1f}%", end='')
        
        urllib.request.urlretrieve(url, zip_path, download_progress)
        print()
        
        # ì••ì¶• í•´ì œ
        print(f"{BLUE}ğŸ“¦ ì••ì¶• í•´ì œ ì¤‘...{RESET}")
        with zipfile.ZipFile(zip_path, 'r') as zip_ref:
            zip_ref.extractall(source_dir.parent)
        
        # ë””ë ‰í† ë¦¬ ì´ë¦„ ë³€ê²½
        extracted = source_dir.parent / "godot-4.3-stable"
        if extracted.exists():
            if source_dir.exists():
                shutil.rmtree(source_dir)
            extracted.rename(source_dir)
        
        # zip íŒŒì¼ ì‚­ì œ
        zip_path.unlink()
        
        print(f"{GREEN}âœ… ì†ŒìŠ¤ì½”ë“œ ì¤€ë¹„ ì™„ë£Œ{RESET}")
        return source_dir
        
    except Exception as e:
        print(f"{RED}âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {e}{RESET}")
        return None

def build_windows_exe(source_dir, output_dir):
    """Windows exe í¬ë¡œìŠ¤ ì»´íŒŒì¼"""
    print(f"\n{BLUE}ğŸ”¨ Windows exe ë¹Œë“œ ì‹œì‘...{RESET}")
    print(f"{YELLOW}â±ï¸  ì˜ˆìƒ ì‹œê°„: 30-60ë¶„{RESET}")
    
    # ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
    output_dir.mkdir(parents=True, exist_ok=True)
    
    # ë¹Œë“œ ë¡œê·¸ ë””ë ‰í† ë¦¬
    log_dir = output_dir.parent / "logs"
    log_dir.mkdir(exist_ok=True)
    
    # ì›ë˜ ë””ë ‰í† ë¦¬ ì €ì¥
    original_dir = os.getcwd()
    os.chdir(source_dir)
    
    try:
        # Windows í¬ë¡œìŠ¤ ì»´íŒŒì¼ ëª…ë ¹
        build_cmd = [
            "scons",
            "platform=windows",
            "target=editor",
            "arch=x86_64",
            "use_mingw=yes",
            "-j4",  # 4ê°œ ì½”ì–´ ì‚¬ìš©
            "production=yes"
        ]
        
        print(f"ì‹¤í–‰ ëª…ë ¹: {' '.join(build_cmd)}")
        
        # ë¡œê·¸ íŒŒì¼
        log_file = log_dir / f"build_windows_{int(time.time())}.log"
        
        start_time = time.time()
        
        # ë¹Œë“œ ì‹¤í–‰
        with open(log_file, 'w') as log:
            process = subprocess.Popen(
                build_cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                bufsize=1
            )
            
            # ì§„í–‰ ìƒí™© í‘œì‹œ
            line_count = 0
            for line in process.stdout:
                log.write(line)
                line_count += 1
                if line_count % 100 == 0:
                    elapsed = time.time() - start_time
                    print(f"\r  ì§„í–‰ ì¤‘... ({elapsed/60:.1f}ë¶„ ê²½ê³¼)", end='')
            
            process.wait()
        
        build_time = time.time() - start_time
        
        if process.returncode == 0:
            print(f"\n{GREEN}âœ… ë¹Œë“œ ì„±ê³µ! ({build_time/60:.1f}ë¶„ ì†Œìš”){RESET}")
            
            # ë¹Œë“œëœ exe ì°¾ê¸°
            bin_dir = source_dir / "bin"
            exe_files = list(bin_dir.glob("godot.windows.editor.x86_64*.exe"))
            
            if exe_files:
                source_exe = exe_files[0]
                target_exe = output_dir / "godot.windows.editor.x86_64.exe"
                
                # ë³µì‚¬
                shutil.copy2(source_exe, target_exe)
                print(f"{GREEN}âœ… ë¹Œë“œëœ íŒŒì¼: {target_exe}{RESET}")
                return target_exe
            else:
                print(f"{RED}âŒ ë¹Œë“œëœ exe íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.{RESET}")
                return None
        else:
            print(f"\n{RED}âŒ ë¹Œë“œ ì‹¤íŒ¨ (ì½”ë“œ: {process.returncode}){RESET}")
            print(f"ë¡œê·¸ í™•ì¸: {log_file}")
            return None
            
    except Exception as e:
        print(f"{RED}âŒ ë¹Œë“œ ì¤‘ ì˜¤ë¥˜: {e}{RESET}")
        return None
    finally:
        os.chdir(original_dir)

def main():
    print(f"\n{BLUE}ğŸ¤– AutoCI - AI Godot Windows ë¹Œë“œ ì‹œìŠ¤í…œ{RESET}")
    print("=" * 50)
    
    # ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜ ì°¾ê¸°
    if Path(__file__).is_symlink():
        script_path = Path(os.readlink(__file__))
    else:
        script_path = Path(__file__).resolve()
    
    project_dir = script_path.parent
    
    # ì˜ì¡´ì„± í™•ì¸
    has_mingw = check_dependencies()
    
    output_dir = project_dir / "godot_ai_build" / "output"
    exe_path = None
    
    if has_mingw:
        # MinGWê°€ ìˆìœ¼ë©´ ì†ŒìŠ¤ì—ì„œ ë¹Œë“œ
        # ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ
        source_dir = download_godot_source(project_dir)
        if source_dir:
            # Windows exe ë¹Œë“œ
            exe_path = build_windows_exe(source_dir, output_dir)
    
    if exe_path:
        print(f"\n{GREEN}ğŸ‰ ë¹Œë“œ ì™„ë£Œ!{RESET}")
        print(f"ğŸ“ Windows exe ê²½ë¡œ: {exe_path}")
        print(f"\në‹¤ìŒ ë‹¨ê³„:")
        print(f"1. {GREEN}autoci{RESET} ëª…ë ¹ì–´ë¡œ ì‹¤í–‰")
        print(f"2. ë¹Œë“œëœ Godotì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤")
        return 0
    else:
        # MinGWê°€ ì—†ê±°ë‚˜ ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ë¯¸ë¦¬ ë¹Œë“œëœ ë²„ì „ ë‹¤ìš´ë¡œë“œ
        if not has_mingw:
            print(f"\n{YELLOW}ğŸ“¥ ë¯¸ë¦¬ ë¹Œë“œëœ Windows Godot ë‹¤ìš´ë¡œë“œ ì¤‘...{RESET}")
        else:
            print(f"\n{YELLOW}ğŸ“¥ ë¹Œë“œ ì‹¤íŒ¨. ë¯¸ë¦¬ ë¹Œë“œëœ Godot ë‹¤ìš´ë¡œë“œ ì¤‘...{RESET}")
        
        godot_url = "https://downloads.tuxfamily.org/godotengine/4.3/Godot_v4.3-stable_win64.exe.zip"
        output_dir.mkdir(parents=True, exist_ok=True)
        zip_path = output_dir / "godot_windows.zip"
        exe_path = output_dir / "godot.windows.editor.x86_64.exe"
        
        try:
            print(f"  URL: {godot_url}")
            
            def download_progress(block_num, block_size, total_size):
                downloaded = block_num * block_size
                percent = min(downloaded * 100 / total_size, 100)
                mb_downloaded = downloaded / (1024 * 1024)
                mb_total = total_size / (1024 * 1024)
                print(f"\r  ë‹¤ìš´ë¡œë“œ ì¤‘... {percent:.1f}% ({mb_downloaded:.1f}MB / {mb_total:.1f}MB)", end='')
            
            urllib.request.urlretrieve(godot_url, zip_path, download_progress)
            print()  # ìƒˆ ì¤„
            
            with zipfile.ZipFile(zip_path, 'r') as zip_ref:
                zip_ref.extractall(output_dir)
            
            # íŒŒì¼ ì´ë¦„ ë³€ê²½
            downloaded_exe = output_dir / "Godot_v4.3-stable_win64.exe"
            if downloaded_exe.exists():
                downloaded_exe.rename(exe_path)
            
            zip_path.unlink()
            
            print(f"{GREEN}âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: {exe_path}{RESET}")
            return 0
            
        except Exception as e:
            print(f"{RED}âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {e}{RESET}")
            return 1

if __name__ == "__main__":
    sys.exit(main())