#!/usr/bin/env python3
"""
AutoCI ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ëª…ë ¹ì–´
ì‹¤ì‹œê°„ìœ¼ë¡œ ì‹œìŠ¤í…œ ìƒíƒœ, ê²Œì„ ê°œë°œ ì§„í–‰ìƒí™©, AI í•™ìŠµ ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.
"""

import os
import sys
import asyncio
import argparse
import json
import time
from pathlib import Path
from datetime import datetime, timedelta
import psutil

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
project_root = Path(__file__).parent.absolute()
sys.path.insert(0, str(project_root))

try:
    from modules.monitoring_system import ProductionMonitor, MetricType
    from modules.enhanced_logging import setup_enhanced_logging
except ImportError as e:
    print(f"âŒ ëª¨ë“ˆ import ì˜¤ë¥˜: {e}")
    print("ğŸ”§ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ê°€ìƒí™˜ê²½ì„ í™œì„±í™”í•´ì£¼ì„¸ìš”:")
    print("   source autoci_env/bin/activate")
    sys.exit(1)

class AutoCIMonitor:
    """AutoCI ëª¨ë‹ˆí„°ë§ ì¸í„°í˜ì´ìŠ¤"""
    
    def __init__(self):
        self.monitor = ProductionMonitor()
        self.running = False
        
    async def start_monitoring(self):
        """ëª¨ë‹ˆí„°ë§ ì‹œì‘"""
        print("ğŸš€ AutoCI ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì„ ì‹œì‘í•©ë‹ˆë‹¤...")
        await self.monitor.start()
        self.running = True
        print("âœ… ëª¨ë‹ˆí„°ë§ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!")
        
    async def stop_monitoring(self):
        """ëª¨ë‹ˆí„°ë§ ì¤‘ì§€"""
        if self.running:
            print("ğŸ›‘ ëª¨ë‹ˆí„°ë§ì„ ì¤‘ì§€í•©ë‹ˆë‹¤...")
            await self.monitor.stop()
            self.running = False
            print("âœ… ëª¨ë‹ˆí„°ë§ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!")
    
    async def show_status(self):
        """ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ"""
        print("\n" + "="*60)
        print("ğŸ“Š AutoCI ì‹œìŠ¤í…œ ìƒíƒœ")
        print("="*60)
        
        # ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­
        cpu_percent = psutil.cpu_percent()
        memory = psutil.virtual_memory()
        disk = psutil.disk_usage('/')
        
        print(f"ğŸ–¥ï¸  CPU ì‚¬ìš©ë¥ : {cpu_percent:.1f}%")
        print(f"ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : {memory.percent:.1f}% ({memory.used // (1024**3):.1f}GB / {memory.total // (1024**3):.1f}GB)")
        print(f"ğŸ’¿ ë””ìŠ¤í¬ ì‚¬ìš©ë¥ : {disk.percent:.1f}% ({disk.used // (1024**3):.1f}GB / {disk.total // (1024**3):.1f}GB)")
        
        # í—¬ìŠ¤ ì²´í¬ ìƒíƒœ
        health_summary = self.monitor.get_health_summary()
        print(f"\nğŸ¥ í—¬ìŠ¤ ì²´í¬: {health_summary.get('overall_status', 'Unknown')}")
        
        # ì¹´ìš´í„° ì •ë³´
        print(f"\nğŸ“ˆ ê²Œì„ ê°œë°œ í†µê³„:")
        for name, count in self.monitor.counters.items():
            display_name = {
                "games_created": "ìƒì„±ëœ ê²Œì„",
                "features_added": "ì¶”ê°€ëœ ê¸°ëŠ¥", 
                "bugs_fixed": "ìˆ˜ì •ëœ ë²„ê·¸",
                "errors_caught": "í¬ì°©ëœ ì˜¤ë¥˜",
                "ai_requests": "AI ìš”ì²­",
                "ai_tokens_used": "ì‚¬ìš©ëœ í† í°"
            }.get(name, name)
            print(f"   {display_name}: {count}")
        
        # ìµœê·¼ ë©”íŠ¸ë¦­
        metrics_summary = self.monitor.get_metrics_summary(duration_minutes=10)
        print(f"\nğŸ“Š ìµœê·¼ 10ë¶„ ë©”íŠ¸ë¦­ ìš”ì•½:")
        print(f"   ìˆ˜ì§‘ëœ ë©”íŠ¸ë¦­: {metrics_summary.get('total_metrics', 0)}")
        print(f"   í‰ê·  CPU: {metrics_summary.get('avg_cpu', 0):.1f}%")
        print(f"   í‰ê·  ë©”ëª¨ë¦¬: {metrics_summary.get('avg_memory', 0):.1f}%")
        
        print("="*60)
    
    async def show_learning_status(self):
        """AI í•™ìŠµ ìƒíƒœ í‘œì‹œ"""
        print("\n" + "="*60)
        print("ğŸ§  AI í•™ìŠµ ìƒíƒœ")
        print("="*60)
        
        # í•™ìŠµ ì§„í–‰ ìƒíƒœ íŒŒì¼ í™•ì¸
        progress_files = [
            "user_learning_data/continuous_learning/progress/learning_progress.json",
            "continuous_learning/progress/learning_progress.json",
            "user_learning_data/learning_summary_*.json"
        ]
        
        learning_active = False
        for progress_file in progress_files:
            if Path(progress_file).exists():
                try:
                    with open(progress_file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                    learning_active = True
                    
                    print(f"ğŸ“š í•™ìŠµ íŒŒì¼: {progress_file}")
                    if 'total_hours' in data:
                        print(f"   ì´ í•™ìŠµ ì‹œê°„: {data['total_hours']:.1f}ì‹œê°„")
                    if 'total_questions' in data:
                        print(f"   ì´ ì§ˆë¬¸ ìˆ˜: {data['total_questions']}")
                    if 'total_successful' in data:
                        print(f"   ì„±ê³µí•œ ë‹µë³€: {data['total_successful']}")
                    break
                except Exception as e:
                    continue
        
        if not learning_active:
            print("ğŸ“– í˜„ì¬ í™œì„±í™”ëœ í•™ìŠµ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.")
            print("ğŸ’¡ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ í•™ìŠµì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:")
            print("   autoci learn")
            print("   autoci learn low")
        
        print("="*60)
    
    async def show_game_projects(self):
        """ê²Œì„ í”„ë¡œì íŠ¸ ìƒíƒœ í‘œì‹œ"""
        print("\n" + "="*60)
        print("ğŸ® ê²Œì„ í”„ë¡œì íŠ¸ ìƒíƒœ")
        print("="*60)
        
        # ê²Œì„ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸
        project_dirs = ["game_projects", "mvp_games", "accurate_games"]
        
        total_projects = 0
        for project_dir in project_dirs:
            if Path(project_dir).exists():
                projects = list(Path(project_dir).iterdir())
                if projects:
                    print(f"ğŸ“ {project_dir}:")
                    for project in projects[:5]:  # ìµœëŒ€ 5ê°œë§Œ í‘œì‹œ
                        if project.is_dir():
                            # í”„ë¡œì íŠ¸ ìƒì„± ì‹œê°„ í™•ì¸
                            try:
                                create_time = datetime.fromtimestamp(project.stat().st_ctime)
                                print(f"   ğŸ¯ {project.name} - {create_time.strftime('%Y-%m-%d %H:%M')}")
                                total_projects += 1
                            except:
                                print(f"   ğŸ¯ {project.name}")
                                total_projects += 1
                    
                    if len(projects) > 5:
                        print(f"   ... ë° {len(projects) - 5}ê°œ ë”")
        
        if total_projects == 0:
            print("ğŸ® ìƒì„±ëœ ê²Œì„ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
            print("ğŸ’¡ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ê²Œì„ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤:")
            print("   autoci")
            print("   > create platformer game")
        else:
            print(f"\nğŸ“Š ì´ {total_projects}ê°œì˜ ê²Œì„ í”„ë¡œì íŠ¸")
        
        print("="*60)
    
    async def show_logs(self, lines=50):
        """ìµœê·¼ ë¡œê·¸ í‘œì‹œ"""
        print(f"\nğŸ“œ ìµœê·¼ ë¡œê·¸ ({lines}ì¤„)")
        print("="*60)
        
        log_files = [
            "logs/autoci.log",
            "logs/monitoring.log", 
            "continuous_learning.log",
            "user_learning_data/continuous_learning/latest.log"
        ]
        
        for log_file in log_files:
            if Path(log_file).exists():
                print(f"\nğŸ“„ {log_file}:")
                try:
                    with open(log_file, 'r', encoding='utf-8') as f:
                        all_lines = f.readlines()
                        recent_lines = all_lines[-lines:] if len(all_lines) > lines else all_lines
                        
                        for line in recent_lines[-10:]:  # ìµœê·¼ 10ì¤„ë§Œ
                            print(f"   {line.rstrip()}")
                        
                        if len(recent_lines) > 10:
                            print(f"   ... (ì´ {len(recent_lines)}ì¤„)")
                            
                except Exception as e:
                    print(f"   âŒ ë¡œê·¸ ì½ê¸° ì‹¤íŒ¨: {e}")
        
        print("="*60)
    
    async def interactive_mode(self):
        """ëŒ€í™”í˜• ëª¨ë“œ"""
        print("\nğŸ›ï¸ AutoCI ëª¨ë‹ˆí„°ë§ ëŒ€í™”í˜• ëª¨ë“œ")
        print("ëª…ë ¹ì–´: status, learning, projects, logs, start, stop, help, quit")
        
        while True:
            try:
                command = input("\nmonitor> ").strip().lower()
                
                if command in ['quit', 'exit', 'q']:
                    break
                elif command in ['status', 's']:
                    await self.show_status()
                elif command in ['learning', 'learn', 'l']:
                    await self.show_learning_status()
                elif command in ['projects', 'games', 'p']:
                    await self.show_game_projects()
                elif command in ['logs', 'log']:
                    await self.show_logs()
                elif command == 'start':
                    await self.start_monitoring()
                elif command == 'stop':
                    await self.stop_monitoring()
                elif command in ['help', 'h']:
                    print("""
ğŸ“– ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:
  status, s     - ì‹œìŠ¤í…œ ìƒíƒœ í‘œì‹œ
  learning, l   - AI í•™ìŠµ ìƒíƒœ í‘œì‹œ  
  projects, p   - ê²Œì„ í”„ë¡œì íŠ¸ ìƒíƒœ í‘œì‹œ
  logs          - ìµœê·¼ ë¡œê·¸ í‘œì‹œ
  start         - ëª¨ë‹ˆí„°ë§ ì‹œì‘
  stop          - ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
  help, h       - ë„ì›€ë§ í‘œì‹œ
  quit, q       - ì¢…ë£Œ
                    """)
                else:
                    print(f"âŒ ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: {command}")
                    print("ğŸ’¡ 'help'ë¥¼ ì…ë ¥í•˜ë©´ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                    
            except KeyboardInterrupt:
                print("\n\nğŸ‘‹ ëª¨ë‹ˆí„°ë§ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
                break
            except Exception as e:
                print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        
        await self.stop_monitoring()

async def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    parser = argparse.ArgumentParser(description="AutoCI ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ")
    parser.add_argument('--status', action='store_true', help='ì‹œìŠ¤í…œ ìƒíƒœ í‘œì‹œ')
    parser.add_argument('--learning', action='store_true', help='AI í•™ìŠµ ìƒíƒœ í‘œì‹œ')
    parser.add_argument('--projects', action='store_true', help='ê²Œì„ í”„ë¡œì íŠ¸ ìƒíƒœ í‘œì‹œ')
    parser.add_argument('--logs', action='store_true', help='ìµœê·¼ ë¡œê·¸ í‘œì‹œ')
    parser.add_argument('--start', action='store_true', help='ëª¨ë‹ˆí„°ë§ ì‹œì‘')
    parser.add_argument('--interactive', '-i', action='store_true', help='ëŒ€í™”í˜• ëª¨ë“œ')
    parser.add_argument('--watch', '-w', type=int, metavar='SECONDS', help='ì§€ì •ëœ ì´ˆë§ˆë‹¤ ìƒíƒœ ìƒˆë¡œê³ ì¹¨')
    
    args = parser.parse_args()
    
    # ë¡œê¹… ì„¤ì •
    setup_enhanced_logging()
    
    monitor = AutoCIMonitor()
    
    try:
        if args.interactive:
            await monitor.interactive_mode()
        elif args.watch:
            print(f"ğŸ”„ {args.watch}ì´ˆë§ˆë‹¤ ìƒíƒœë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤. (Ctrl+Cë¡œ ì¤‘ì§€)")
            while True:
                os.system('clear' if os.name == 'posix' else 'cls')
                await monitor.show_status()
                await asyncio.sleep(args.watch)
        elif args.start:
            await monitor.start_monitoring()
            print("ğŸ’¡ ëŒ€í™”í˜• ëª¨ë“œë¡œ ì§„ì…í•˜ë ¤ë©´ 'autoci-monitor -i'ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.")
        elif args.status:
            await monitor.show_status()
        elif args.learning:
            await monitor.show_learning_status()
        elif args.projects:
            await monitor.show_game_projects()
        elif args.logs:
            await monitor.show_logs()
        else:
            # ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ìƒíƒœ í‘œì‹œ
            await monitor.show_status()
            await monitor.show_learning_status()
            await monitor.show_game_projects()
            
            print(f"\nğŸ’¡ ì‚¬ìš©ë²•:")
            print(f"  autoci-monitor -i          # ëŒ€í™”í˜• ëª¨ë“œ")
            print(f"  autoci-monitor --status    # ì‹œìŠ¤í…œ ìƒíƒœë§Œ")
            print(f"  autoci-monitor --learning  # í•™ìŠµ ìƒíƒœë§Œ")
            print(f"  autoci-monitor --projects  # ê²Œì„ í”„ë¡œì íŠ¸ë§Œ")
            print(f"  autoci-monitor -w 5        # 5ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨")
            
    except KeyboardInterrupt:
        print("\n\nğŸ‘‹ ëª¨ë‹ˆí„°ë§ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()
    finally:
        await monitor.stop_monitoring()

if __name__ == "__main__":
    asyncio.run(main())